name: Build External Camera HAL

on:
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        df -h
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential \
          zip curl zlib1g-dev gcc-multilib g++-multilib \
          libc6-dev-i386 libncurses5 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z1-dev \
          libgl1-mesa-dev libxml2-utils xsltproc unzip \
          fontconfig python3 repo
    
    - name: Download minimal AOSP
      run: |
        mkdir -p aosp && cd aosp
        repo init -u https://android.googlesource.com/platform/manifest -b android-10.0.0_r47 --depth=1
        
        # 创建目录并添加配置
        mkdir -p .repo/local_manifests
        cat > .repo/local_manifests/remove_projects.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remove-project name="kernel/msm" />
          <remove-project name="device/google/coral" />
        </manifest>
        EOF
        
        # 只同步必要的项目
        repo sync -c -j$(nproc) --no-tags --no-clone-bundle --force-sync \
          hardware/interfaces \
          system/core \
          system/libbase \
          system/libhidl \
          frameworks/native \
          external/tinyxml2 \
          build/make \
          build/soong \
          prebuilts/clang/host/linux-x86 \
          prebuilts/build-tools
    
    - name: Build
      run: |
        cd aosp
        source build/envsetup.sh
        lunch aosp_arm64-userdebug
        
        # 只编译 external camera
        m android.hardware.camera.provider@2.4-external-service -j$(nproc)
    
    - name: Create Magisk module
      run: |
        mkdir -p magisk_module/system/vendor/bin/hw
        mkdir -p magisk_module/system/vendor/lib64/hw
        mkdir -p magisk_module/system/vendor/etc/init
        mkdir -p magisk_module/system/vendor/etc
        
        # 复制编译产物
        cp aosp/out/target/product/generic_arm64/vendor/bin/hw/android.hardware.camera.provider@2.4-external-service magisk_module/system/vendor/bin/hw/
        cp aosp/out/target/product/generic_arm64/vendor/lib64/hw/android.hardware.camera.provider@2.4-external.so magisk_module/system/vendor/lib64/hw/
        
        # 复制配置
        cp external_camera_config.xml magisk_module/system/vendor/etc/
        
        # 创建 init.rc
        cat > magisk_module/system/vendor/etc/init/android.hardware.camera.provider@2.4-external-service.rc << 'EOF'
        service vendor.camera-provider-2-4-ext /vendor/bin/hw/android.hardware.camera.provider@2.4-external-service
            interface android.hardware.camera.provider@2.4::ICameraProvider external/0
            class hal
            user cameraserver
            group audio camera input drmrpc usb
            ioprio rt 4
            capabilities SYS_NICE
        EOF
        
        # 创建 module.prop
        cat > magisk_module/module.prop << 'EOF'
        id=external_camera_hal
        name=External Camera HAL
        version=1.0
        versionCode=1
        author=qxjz12345
        description=Enable external camera support for v4l2loopback
        EOF
        
        # 打包
        cd magisk_module
        zip -r ../external_camera_hal.zip *
    
    - name: Upload Magisk module
      uses: actions/upload-artifact@v4
      with:
        name: external-camera-hal-magisk
        path: external_camera_hal.zip
